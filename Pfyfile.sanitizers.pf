# Sanitizer Integration for pf-runner
# Turnkey enabling of libasan, memsan, ubsan, tsan and other sanitizers with clang

# Installation Tasks

task install-sanitizer-tools
  describe Install and configure sanitizer toolchain
  shell echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
  shell echo "â•‘         INSTALLING SANITIZER TOOLCHAIN                    â•‘"
  shell echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  shell echo ""
  shell echo "[1/4] Installing clang and LLVM tools..."
  packages clang llvm llvm-dev libc++-dev libc++abi-dev
  shell echo ""
  shell echo "[2/4] Installing additional sanitizer dependencies..."
  packages gcc-multilib g++-multilib
  shell echo ""
  shell echo "[3/4] Setting up sanitizer environment..."
  shell mkdir -p ~/.local/bin ~/.local/lib/sanitizers
  shell echo ""
  shell echo "[4/4] Creating sanitizer wrapper scripts..."
  shell pf create-sanitizer-wrappers
  shell echo ""
  shell echo "âœ… Sanitizer toolchain installed successfully"
  shell echo "Test with: pf sanitizer-test"
end

task create-sanitizer-wrappers
  describe Create compiler wrapper scripts for easy sanitizer usage
  shell mkdir -p ~/.local/bin
  shell python3 tools/sanitizers/create_wrappers.py
  shell echo "âœ… Sanitizer wrapper scripts created"
end

# Sanitizer Build Tasks

task build-with-asan
  describe Build project with AddressSanitizer (detects memory errors)
  shell echo "ğŸ” Building with AddressSanitizer..."
  env CC=clang CXX=clang++
  env CFLAGS="-fsanitize=address -fno-omit-frame-pointer -g -O1"
  env CXXFLAGS="-fsanitize=address -fno-omit-frame-pointer -g -O1"
  env LDFLAGS="-fsanitize=address"
  autobuild ${dir:+dir=$dir} ${jobs:+jobs=$jobs} ${release:+release=$release}
  shell echo "âœ… Build complete with AddressSanitizer"
  shell echo "Run with: ASAN_OPTIONS=detect_leaks=1:abort_on_error=1 ./your_binary"
end

task build-with-msan
  describe Build project with MemorySanitizer (detects uninitialized memory)
  shell echo "ğŸ” Building with MemorySanitizer..."
  env CC=clang CXX=clang++
  env CFLAGS="-fsanitize=memory -fno-omit-frame-pointer -g -O1"
  env CXXFLAGS="-fsanitize=memory -fno-omit-frame-pointer -g -O1"
  env LDFLAGS="-fsanitize=memory"
  autobuild ${dir:+dir=$dir} ${jobs:+jobs=$jobs} ${release:+release=$release}
  shell echo "âœ… Build complete with MemorySanitizer"
  shell echo "Run with: MSAN_OPTIONS=print_stats=1:halt_on_error=1 ./your_binary"
end

task build-with-ubsan
  describe Build project with UndefinedBehaviorSanitizer (detects undefined behavior)
  shell echo "ğŸ” Building with UndefinedBehaviorSanitizer..."
  env CC=clang CXX=clang++
  env CFLAGS="-fsanitize=undefined -fno-omit-frame-pointer -g -O1"
  env CXXFLAGS="-fsanitize=undefined -fno-omit-frame-pointer -g -O1"
  env LDFLAGS="-fsanitize=undefined"
  autobuild ${dir:+dir=$dir} ${jobs:+jobs=$jobs} ${release:+release=$release}
  shell echo "âœ… Build complete with UndefinedBehaviorSanitizer"
  shell echo "Run with: UBSAN_OPTIONS=print_stacktrace=1:halt_on_error=1 ./your_binary"
end

task build-with-tsan
  describe Build project with ThreadSanitizer (detects data races)
  shell echo "ğŸ” Building with ThreadSanitizer..."
  env CC=clang CXX=clang++
  env CFLAGS="-fsanitize=thread -fno-omit-frame-pointer -g -O1"
  env CXXFLAGS="-fsanitize=thread -fno-omit-frame-pointer -g -O1"
  env LDFLAGS="-fsanitize=thread"
  autobuild ${dir:+dir=$dir} ${jobs:+jobs=$jobs} ${release:+release=$release}
  shell echo "âœ… Build complete with ThreadSanitizer"
  shell echo "Run with: TSAN_OPTIONS=halt_on_error=1:history_size=7 ./your_binary"
end

task build-with-all-sanitizers
  describe Build project with multiple sanitizers (asan+ubsan, safe combination)
  shell echo "ğŸ” Building with AddressSanitizer + UndefinedBehaviorSanitizer..."
  env CC=clang CXX=clang++
  env CFLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer -g -O1"
  env CXXFLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer -g -O1"
  env LDFLAGS="-fsanitize=address,undefined"
  autobuild ${dir:+dir=$dir} ${jobs:+jobs=$jobs} ${release:+release=$release}
  shell echo "âœ… Build complete with multiple sanitizers"
  shell echo "Run with: ASAN_OPTIONS=detect_leaks=1 UBSAN_OPTIONS=print_stacktrace=1 ./your_binary"
end

# Educational and Testing Tasks

task sanitizer-test
  describe Test sanitizer installation and basic functionality
  shell echo "ğŸ§ª Testing sanitizer installation..."
  shell echo ""
  shell TEST_ASAN=$(mktemp)
  shell TEST_MSAN=$(mktemp)
  shell TEST_UBSAN=$(mktemp)
  shell trap 'rm -f $TEST_ASAN $TEST_MSAN $TEST_UBSAN' EXIT
  shell echo "1. Testing clang with AddressSanitizer..."
  shell echo 'int main(){char *p=malloc(10); p[10]=1; return 0;}' | clang -x c -fsanitize=address -o $TEST_ASAN - 2>&1 | head -5 || true
  shell echo "2. Testing clang with MemorySanitizer..."
  shell echo 'int main(){int x; return x;}' | clang -x c -fsanitize=memory -o $TEST_MSAN - 2>/dev/null || echo "MSan requires special libc (expected)"
  shell echo "3. Testing clang with UBSan..."
  shell echo '#include <limits.h>' | cat - <(echo 'int main(){int x=INT_MAX; return x+1;}') | clang -x c -fsanitize=undefined -o $TEST_UBSAN - 2>&1 | head -5 || true
  shell echo ""
  shell echo "âœ… Sanitizer installation test complete!"
end

# Advanced Sanitizer Features

task sanitizer-coverage
  describe Build with sanitizer coverage for guided fuzzing
  shell echo "ğŸ“Š Building with sanitizer coverage..."
  env CC=clang CXX=clang++
  env CFLAGS="-fsanitize=address -fsanitize-coverage=trace-pc-guard,trace-cmp,trace-div -fno-omit-frame-pointer -g -O1"
  env CXXFLAGS="-fsanitize=address -fsanitize-coverage=trace-pc-guard,trace-cmp,trace-div -fno-omit-frame-pointer -g -O1"
  env LDFLAGS="-fsanitize=address"
  autobuild ${dir:+dir=$dir} ${jobs:+jobs=$jobs}
  shell echo "âœ… Build complete with sanitizer coverage"
end

# Help and Documentation

task sanitizer-help
  describe Show comprehensive sanitizer usage help
  shell echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
  shell echo "â•‘         SANITIZER INTEGRATION HELP                        â•‘"
  shell echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  shell echo ""
  shell echo "INSTALLATION:"
  shell echo "  pf install-sanitizer-tools    # Install complete toolchain"
  shell echo "  pf sanitizer-test            # Test installation"
  shell echo ""
  shell echo "BUILDING WITH SANITIZERS:"
  shell echo "  pf build-with-asan           # AddressSanitizer (memory errors)"
  shell echo "  pf build-with-msan           # MemorySanitizer (uninitialized memory)"
  shell echo "  pf build-with-ubsan          # UBSan (undefined behavior)"
  shell echo "  pf build-with-tsan           # ThreadSanitizer (data races)"
  shell echo "  pf build-with-all-sanitizers # Multiple sanitizers (asan+ubsan)"
  shell echo ""
  shell echo "ADVANCED FEATURES:"
  shell echo "  pf sanitizer-coverage                   # Build with coverage"
  shell echo ""
  shell echo "SANITIZER ENVIRONMENT VARIABLES:"
  shell echo "  ASAN_OPTIONS=detect_leaks=1:abort_on_error=1"
  shell echo "  MSAN_OPTIONS=print_stats=1:halt_on_error=1"
  shell echo "  UBSAN_OPTIONS=print_stacktrace=1:halt_on_error=1"
  shell echo "  TSAN_OPTIONS=halt_on_error=1:history_size=7"
  shell echo ""
  shell echo "For more info: https://clang.llvm.org/docs/AddressSanitizer.html"
end

# Aliases for common operations
[alias san-install] install-sanitizer-tools
[alias san-test] sanitizer-test
[alias san-help] sanitizer-help
[alias build-asan] build-with-asan
[alias build-msan] build-with-msan
[alias build-ubsan] build-with-ubsan
[alias build-tsan] build-with-tsan