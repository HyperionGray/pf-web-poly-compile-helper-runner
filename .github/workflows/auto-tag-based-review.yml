name: "Tag-based Code Review"

on:
  push:
    tags:
      - 'e2eweekly'
      - 'weeklyreview'
      - 'e2e-*'
      - 'review-*'
  workflow_dispatch:
    inputs:
      review_type:
        description: 'Type of review to perform'
        required: true
        default: 'e2e'
        type: choice
        options:
          - e2e
          - weekly
          - full
      ai_model:
        description: 'AI Model to use for review'
        required: false
        default: 'gpt-5.1-codex'
        type: choice
        options:
          - gpt-5.1-codex
          - gpt-5.1
          - gpt-5
          - amazonq
          - codex
          - gemini

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  tag-based-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@main
        with:
          fetch-depth: 0

      - name: Determine Review Type
        id: review-type
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ inputs.review_type }}" >> $GITHUB_OUTPUT
            echo "model=${{ inputs.ai_model }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == *"e2eweekly"* ]] || [[ "${{ github.ref }}" == *"e2e"* ]]; then
            echo "type=e2e" >> $GITHUB_OUTPUT
            echo "model=gpt-5.1-codex" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == *"weeklyreview"* ]] || [[ "${{ github.ref }}" == *"review"* ]]; then
            echo "type=weekly" >> $GITHUB_OUTPUT
            echo "model=gpt-5.1" >> $GITHUB_OUTPUT
          else
            echo "type=full" >> $GITHUB_OUTPUT
            echo "model=gpt-5.1-codex" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@main
        with:
          node-version: '20'
        continue-on-error: true

      - name: Setup Python
        uses: actions/setup-python@main
        with:
          python-version: '3.11'
        continue-on-error: true

      - name: E2E Review with Selected Model
        if: steps.review-type.outputs.type == 'e2e'
        run: |
          echo "# E2E Code Review Report - $(date +%Y-%m-%d)" > /tmp/e2e-review.md
          echo "" >> /tmp/e2e-review.md
          echo "## E2E Testing Analysis" >> /tmp/e2e-review.md
          echo "" >> /tmp/e2e-review.md
          
          # Check for integration points
          echo "### Integration Points" >> /tmp/e2e-review.md
          echo "" >> /tmp/e2e-review.md
          
          # Check for API endpoints
          api_files=$(find . -name "*.py" -o -name "*.js" -o -name "*.ts" | xargs grep -l "app\.\|router\.\|@app\.\|@router\." 2>/dev/null | head -5)
          if [ -n "$api_files" ]; then
            echo "- Found API endpoint definitions in:" >> /tmp/e2e-review.md
            echo "$api_files" | while read file; do
              echo "  - $file" >> /tmp/e2e-review.md
            done
            echo "" >> /tmp/e2e-review.md
          fi
          
          # Check for database connections
          db_files=$(find . -name "*.py" -o -name "*.js" -o -name "*.ts" | xargs grep -l "database\|db\.\|connection\|connect" 2>/dev/null | head -3)
          if [ -n "$db_files" ]; then
            echo "- Database integration files:" >> /tmp/e2e-review.md
            echo "$db_files" | while read file; do
              echo "  - $file" >> /tmp/e2e-review.md
            done
            echo "" >> /tmp/e2e-review.md
          fi
          
          # User flow analysis
          echo "### User Flow Analysis" >> /tmp/e2e-review.md
          echo "" >> /tmp/e2e-review.md
          echo "- Critical user journeys should be tested end-to-end" >> /tmp/e2e-review.md
          echo "- Error handling should be verified in user paths" >> /tmp/e2e-review.md
          echo "- Edge cases in user interactions need coverage" >> /tmp/e2e-review.md
          echo "" >> /tmp/e2e-review.md
          
          # Performance recommendations
          echo "### Performance & Reliability" >> /tmp/e2e-review.md
          echo "" >> /tmp/e2e-review.md
          echo "- Monitor for performance bottlenecks in E2E scenarios" >> /tmp/e2e-review.md
          echo "- Implement proper timeout handling" >> /tmp/e2e-review.md
          echo "- Add retry mechanisms for flaky operations" >> /tmp/e2e-review.md
          echo "" >> /tmp/e2e-review.md
          
          cat /tmp/e2e-review.md
        continue-on-error: true

      - name: Weekly Review with Selected Model
        if: steps.review-type.outputs.type == 'weekly'
        run: |
          echo "# Weekly Code Review Report - $(date +%Y-%m-%d)" > /tmp/weekly-review.md
          echo "" >> /tmp/weekly-review.md
          
          # Architecture & Design
          echo "## Architecture & Design" >> /tmp/weekly-review.md
          echo "" >> /tmp/weekly-review.md
          echo "- Review overall system architecture for improvements" >> /tmp/weekly-review.md
          echo "- Check design pattern usage and consistency" >> /tmp/weekly-review.md
          echo "- Verify separation of concerns across modules" >> /tmp/weekly-review.md
          echo "" >> /tmp/weekly-review.md
          
          # Code Quality Trends
          echo "## Code Quality Trends" >> /tmp/weekly-review.md
          echo "" >> /tmp/weekly-review.md
          
          # Check recent commits
          recent_commits=$(git log --oneline --since="1 week ago" 2>/dev/null | wc -l || echo "0")
          echo "- Recent commits in the past week: $recent_commits" >> /tmp/weekly-review.md
          
          # Check for large files that might need refactoring
          large_files=$(find . -name "*.py" -not -path "./.*" -exec wc -l {} + | awk '$1 > 300 {print $2}' | wc -l)
          echo "- Files over 300 lines (potential refactoring candidates): $large_files" >> /tmp/weekly-review.md
          echo "" >> /tmp/weekly-review.md
          
          # Testing Strategy
          echo "## Testing Strategy" >> /tmp/weekly-review.md
          echo "" >> /tmp/weekly-review.md
          test_files=$(find . -name "*test*.py" -o -name "test_*.py" | wc -l)
          echo "- Total test files: $test_files" >> /tmp/weekly-review.md
          echo "- Recommendation: Maintain comprehensive test coverage" >> /tmp/weekly-review.md
          echo "" >> /tmp/weekly-review.md
          
          # Documentation
          echo "## Documentation" >> /tmp/weekly-review.md
          echo "" >> /tmp/weekly-review.md
          if [ -f "README.md" ]; then
            echo "✅ README.md present" >> /tmp/weekly-review.md
          else
            echo "❌ README.md missing" >> /tmp/weekly-review.md
          fi
          
          if [ -f "CONTRIBUTING.md" ]; then
            echo "✅ CONTRIBUTING.md present" >> /tmp/weekly-review.md
          else
            echo "❌ CONTRIBUTING.md missing" >> /tmp/weekly-review.md
          fi
          echo "" >> /tmp/weekly-review.md
          
          # Dependencies & Security
          echo "## Dependencies & Security" >> /tmp/weekly-review.md
          echo "" >> /tmp/weekly-review.md
          echo "- Regular dependency updates recommended" >> /tmp/weekly-review.md
          echo "- Security vulnerability scanning should be automated" >> /tmp/weekly-review.md
          echo "- Monitor for deprecated dependencies" >> /tmp/weekly-review.md
          echo "" >> /tmp/weekly-review.md
          
          cat /tmp/weekly-review.md
        continue-on-error: true

      - name: Full Review with Selected Model
        if: steps.review-type.outputs.type == 'full'
        run: |
          echo "# Full Comprehensive Code Review - $(date +%Y-%m-%d)" > /tmp/full-review.md
          echo "" >> /tmp/full-review.md
          
          # Complete Code Review sections
          echo "## Complete Code Review Summary" >> /tmp/full-review.md
          echo "" >> /tmp/full-review.md
          echo "### 1. Code Quality & Architecture" >> /tmp/full-review.md
          echo "- Review overall system architecture and design patterns" >> /tmp/full-review.md
          echo "- Check for SOLID principles adherence" >> /tmp/full-review.md
          echo "" >> /tmp/full-review.md
          
          echo "### 2. Security Analysis" >> /tmp/full-review.md
          echo "- Scan for common security vulnerabilities" >> /tmp/full-review.md
          echo "- Review authentication and authorization patterns" >> /tmp/full-review.md
          echo "" >> /tmp/full-review.md
          
          echo "### 3. Performance Optimization" >> /tmp/full-review.md
          echo "- Identify performance bottlenecks" >> /tmp/full-review.md
          echo "- Review resource usage patterns" >> /tmp/full-review.md
          echo "" >> /tmp/full-review.md
          
          echo "### 4. Testing Strategy" >> /tmp/full-review.md
          test_files=$(find . -name "*test*.py" -o -name "test_*.py" | wc -l)
          source_files=$(find . -name "*.py" -not -path "./.*" -not -name "*test*" | wc -l)
          echo "- Test files: $test_files" >> /tmp/full-review.md
          echo "- Source files: $source_files" >> /tmp/full-review.md
          echo "- Recommendation: Maintain comprehensive test coverage" >> /tmp/full-review.md
          echo "" >> /tmp/full-review.md
          
          echo "### 5. Documentation Quality" >> /tmp/full-review.md
          if [ -f "README.md" ]; then
            echo "✅ README.md present" >> /tmp/full-review.md
          fi
          if [ -f "CONTRIBUTING.md" ]; then
            echo "✅ CONTRIBUTING.md present" >> /tmp/full-review.md
          fi
          echo "" >> /tmp/full-review.md
          
          echo "### 6. Best Practices Adherence" >> /tmp/full-review.md
          echo "- Follow language-specific best practices" >> /tmp/full-review.md
          echo "- Implement proper error handling" >> /tmp/full-review.md
          echo "" >> /tmp/full-review.md
          
          echo "### 7. E2E Integration" >> /tmp/full-review.md
          echo "- Verify end-to-end functionality" >> /tmp/full-review.md
          echo "- Test critical user workflows" >> /tmp/full-review.md
          echo "" >> /tmp/full-review.md
          
          echo "### 8. API Design" >> /tmp/full-review.md
          echo "- Review API consistency and design" >> /tmp/full-review.md
          echo "- Check for proper HTTP status codes" >> /tmp/full-review.md
          echo "" >> /tmp/full-review.md
          
          echo "### 9. Error Handling" >> /tmp/full-review.md
          echo "- Implement comprehensive error handling" >> /tmp/full-review.md
          echo "- Provide meaningful error messages" >> /tmp/full-review.md
          echo "" >> /tmp/full-review.md
          
          echo "### 10. Maintainability" >> /tmp/full-review.md
          echo "- Code should be readable and well-documented" >> /tmp/full-review.md
          echo "- Follow consistent coding standards" >> /tmp/full-review.md
          echo "" >> /tmp/full-review.md
          
          cat /tmp/full-review.md
        continue-on-error: true

      - name: Generate Review Report
        id: generate-report
        run: |
          echo "## Tag-Based Code Review Report" > /tmp/tag-review-report.md
          echo "" >> /tmp/tag-review-report.md
          echo "**Review Type:** ${{ steps.review-type.outputs.type }}" >> /tmp/tag-review-report.md
          echo "**AI Model:** ${{ steps.review-type.outputs.model }}" >> /tmp/tag-review-report.md
          echo "**Triggered by:** ${{ github.event_name }}" >> /tmp/tag-review-report.md
          echo "**Tag/Branch:** ${{ github.ref }}" >> /tmp/tag-review-report.md
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> /tmp/tag-review-report.md
          echo "" >> /tmp/tag-review-report.md
          
          # Add repository stats
          echo "### Repository Statistics:" >> /tmp/tag-review-report.md
          python_files=$(find . -name "*.py" ! -path "*/.venv/*" ! -path "*/node_modules/*" | wc -l)
          js_files=$(find . -name "*.js" ! -path "*/node_modules/*" ! -path "*/dist/*" | wc -l)
          ts_files=$(find . -name "*.ts" ! -path "*/node_modules/*" ! -path "*/dist/*" | wc -l)
          
          echo "- Python files: $python_files" >> /tmp/tag-review-report.md
          echo "- JavaScript files: $js_files" >> /tmp/tag-review-report.md
          echo "- TypeScript files: $ts_files" >> /tmp/tag-review-report.md
          
          # Add recent commits
          echo "" >> /tmp/tag-review-report.md
          echo "### Recent Changes:" >> /tmp/tag-review-report.md
          git log --oneline -10 >> /tmp/tag-review-report.md || echo "No recent commits" >> /tmp/tag-review-report.md
          
          cat /tmp/tag-review-report.md
        continue-on-error: true

      - name: Create Review Issue
        uses: actions/github-script@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let report = '';
            try {
              report = fs.readFileSync('/tmp/tag-review-report.md', 'utf8');
            } catch (e) {
              report = 'Report generation failed';
            }
            
            const date = new Date().toISOString().split('T')[0];
            const reviewType = '${{ steps.review-type.outputs.type }}';
            const model = '${{ steps.review-type.outputs.model }}';
            const title = `${reviewType.toUpperCase()} Code Review (${model}) - ${date}`;
            
            const body = `# Tag-Based Code Review Report
            
            ${report}
            
            ## Review Configuration
            
            - **Review Type:** ${reviewType}
            - **AI Model:** ${model}
            - **Repository:** ${{ github.repository }}
            - **Branch/Tag:** ${{ github.ref }}
            - **Commit:** ${{ github.sha }}
            - **Triggered by:** ${{ github.event_name }}
            
            ## About This Review
            
            This review was triggered by a tag or manual dispatch. The review type determines the focus:
            
            - **E2E Review:** Comprehensive end-to-end testing and integration analysis
            - **Weekly Review:** Broad code quality, architecture, and trend analysis
            - **Full Review:** Complete analysis covering all aspects
            
            ## Action Items
            
            Review the findings above and:
            - [ ] Address high-priority security issues
            - [ ] Implement suggested architectural improvements
            - [ ] Add missing tests for E2E scenarios
            - [ ] Update documentation as needed
            - [ ] Plan refactoring for technical debt
            
            ---
            *This issue was automatically generated by the Tag-based Code Review workflow using ${model}.*
            `;
            
            // Check for existing issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['tag-review', 'automated'],
              per_page: 10
            });
            
            const recentIssue = issues.data.find(issue => {
              const createdAt = new Date(issue.created_at);
              const daysSinceCreation = (Date.now() - createdAt) / (1000 * 60 * 60 * 24);
              return daysSinceCreation < 7 && issue.title.includes(reviewType);
            });
            
            if (recentIssue) {
              console.log(`Recent ${reviewType} review issue found: #${recentIssue.number}, updating`);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: recentIssue.number,
                body: `## Updated Review (${date})\n\n${report}`
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['tag-review', reviewType, 'automated', 'code-review', 'needs-review']
              });
            }
        continue-on-error: true

      - name: Upload Review Report
        uses: actions/upload-artifact@main
        with:
          name: tag-review-report
          path: /tmp/tag-review-report.md
          retention-days: 90
        continue-on-error: true
