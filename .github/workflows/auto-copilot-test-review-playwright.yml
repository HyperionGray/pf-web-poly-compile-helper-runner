name: "Comprehensive Test Review with Playwright"

# REQUIREMENTS:
# - A GitHub Personal Access Token with Copilot access must be created and stored as a repository secret named COPILOT_TOKEN
# - See COPILOT_TOKEN_SETUP.md for detailed setup instructions

on:
  push:
    branches:
      - main
      - master
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  test-review-and-execution:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
        mode: [headed, headless]
    steps:
      - name: Checkout code
        uses: actions/checkout@main

      - name: Setup Node.js
        uses: actions/setup-node@main
        with:
          node-version: '20'
          cache: 'npm'
        continue-on-error: true

      - name: Setup Python
        uses: actions/setup-python@main
        with:
          python-version: '3.11'
          cache: 'pip'
        continue-on-error: true

      - name: Install Node.js dependencies
        run: |
          if [ -f "package.json" ]; then
            npm install
            npm install -D @playwright/test playwright
          fi
        continue-on-error: true

      - name: Install Python dependencies
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi
          pip install pytest playwright pytest-playwright
        continue-on-error: true

      - name: Install Playwright browsers
        run: |
          npx playwright install --with-deps ${{ matrix.browser }} || python -m playwright install --with-deps ${{ matrix.browser }}
        continue-on-error: true

      - name: Verify Playwright installation
        run: |
          echo "Checking Playwright installation..."
          npx playwright --version || python -m playwright --version || echo "Playwright not installed"

      - name: Run Playwright Tests (Headless)
        if: matrix.mode == 'headless'
        run: |
          if [ -f "playwright.config.ts" ] || [ -f "playwright.config.js" ]; then
            npx playwright test --browser=${{ matrix.browser }}
          elif [ -d "tests" ] && find tests -name "*test*.py" -o -name "*_test.py" | grep -q .; then
            pytest tests/ --browser ${{ matrix.browser }} --headed=false
          else
            echo "No Playwright tests found - this is OK if not a web project"
          fi
        env:
          CI: true
        continue-on-error: true

      - name: Run Playwright Tests (Headed)
        if: matrix.mode == 'headed'
        run: |
          if [ -f "playwright.config.ts" ] || [ -f "playwright.config.js" ]; then
            npx playwright test --browser=${{ matrix.browser }} --headed
          elif [ -d "tests" ] && find tests -name "*test*.py" -o -name "*_test.py" | grep -q .; then
            pytest tests/ --browser ${{ matrix.browser }} --headed=true
          else
            echo "No Playwright tests found - this is OK if not a web project"
          fi
        env:
          CI: true
          DISPLAY: :99
        continue-on-error: true

      - name: Upload Playwright Test Results
        uses: actions/upload-artifact@main
        if: always()
        with:
          name: playwright-results-${{ matrix.browser }}-${{ matrix.mode }}
          path: |
            playwright-report/
            test-results/
            playwright-traces/
          retention-days: 30
        continue-on-error: true

      - name: Upload Playwright Screenshots on Failure
        uses: actions/upload-artifact@main
        if: failure()
        with:
          name: playwright-screenshots-${{ matrix.browser }}-${{ matrix.mode }}
          path: |
            screenshots/
            test-results/**/screenshots/
          retention-days: 7
        continue-on-error: true

  test-coverage-review:
    runs-on: ubuntu-latest
    needs: test-review-and-execution
    steps:
      - name: Checkout code
        uses: actions/checkout@main

      - name: Analyze Test Coverage
        id: coverage
        run: |
          echo "## Test Coverage Analysis" > /tmp/test-analysis.md
          echo "" >> /tmp/test-analysis.md
          
          # Find test files
          echo "### Test Files Found:" >> /tmp/test-analysis.md
          find . -type f \( -name "*test*.js" -o -name "*test*.ts" -o -name "*test*.py" -o -name "*spec*.js" -o -name "*spec*.ts" \) \
            ! -path "*/node_modules/*" \
            ! -path "*/dist/*" \
            ! -path "*/.venv/*" \
            -exec echo "- {}" \; >> /tmp/test-analysis.md || echo "No test files found" >> /tmp/test-analysis.md
          
          echo "" >> /tmp/test-analysis.md
          echo "### Source Files Without Tests:" >> /tmp/test-analysis.md
          
          # Find source files that might need tests
          for file in $(find . -type f \( -name "*.js" -o -name "*.ts" -o -name "*.py" \) \
            ! -path "*/node_modules/*" \
            ! -path "*/dist/*" \
            ! -path "*/build/*" \
            ! -path "*/.venv/*" \
            ! -path "*/vendor/*" \
            ! -name "*test*" \
            ! -name "*spec*"); do
            basename=$(basename "$file" | sed 's/\.[^.]*$//')
            
            # Check if corresponding test file exists
            if ! find . -name "*${basename}*test*" -o -name "*${basename}*spec*" 2>/dev/null | grep -q .; then
              echo "- $file (no corresponding test found)" >> /tmp/test-analysis.md
            fi
          done
          
          cat /tmp/test-analysis.md

      - name: GitHub Copilot Test Review
        run: |
          echo "## GitHub Copilot Test Review" > /tmp/copilot-test-review.md
          echo "" >> /tmp/copilot-test-review.md
          echo "**Review Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> /tmp/copilot-test-review.md
          echo "" >> /tmp/copilot-test-review.md
          
          echo "### Playwright Test Coverage Analysis" >> /tmp/copilot-test-review.md
          echo "" >> /tmp/copilot-test-review.md
          
          # Check for Playwright configuration
          if [ -f "playwright.config.ts" ] || [ -f "playwright.config.js" ]; then
            echo "- ✅ Playwright configuration found" >> /tmp/copilot-test-review.md
            
            # Count Playwright test files
            PLAYWRIGHT_TESTS=$(find . -name "*.spec.ts" -o -name "*.spec.js" -o -name "*.test.ts" -o -name "*.test.js" | \
              grep -E "(e2e|playwright|spec)" | wc -l)
            echo "- Playwright test files: $PLAYWRIGHT_TESTS" >> /tmp/copilot-test-review.md
          else
            echo "- ❌ Playwright configuration not found" >> /tmp/copilot-test-review.md
            echo "- **Recommendation:** Set up Playwright for E2E testing" >> /tmp/copilot-test-review.md
          fi
          
          echo "" >> /tmp/copilot-test-review.md
          echo "### Test Quality Assessment" >> /tmp/copilot-test-review.md
          
          # Check for test organization
          TEST_DIRS=$(find . -type d -name "*test*" -o -name "*spec*" | wc -l)
          echo "- Test directories: $TEST_DIRS" >> /tmp/copilot-test-review.md
          
          # Check for different test types
          UNIT_TESTS=$(find . -name "*test*.py" -o -name "*test*.js" -o -name "*test*.ts" | \
            grep -v "e2e\|spec" | wc -l)
          echo "- Unit test files: $UNIT_TESTS" >> /tmp/copilot-test-review.md
          
          E2E_TESTS=$(find . -name "*e2e*" -o -name "*spec*" | grep -E "\.(js|ts|py)$" | wc -l)
          echo "- E2E test files: $E2E_TESTS" >> /tmp/copilot-test-review.md
          
          echo "" >> /tmp/copilot-test-review.md
          echo "### Test Best Practices Check" >> /tmp/copilot-test-review.md
          
          # Check for proper test structure
          if find . -name "*.spec.ts" -o -name "*.spec.js" | head -1 > /dev/null 2>&1; then
            DESCRIBE_BLOCKS=$(find . -name "*.spec.ts" -o -name "*.spec.js" | \
              xargs grep -l "describe\|test\|it" 2>/dev/null | wc -l)
            echo "- Files with proper test structure (describe/test blocks): $DESCRIBE_BLOCKS" >> /tmp/copilot-test-review.md
          fi
          
          # Check for assertions
          ASSERTION_FILES=$(find . -name "*test*.js" -o -name "*test*.ts" -o -name "*spec*.js" -o -name "*spec*.ts" | \
            xargs grep -l "expect\|assert\|should" 2>/dev/null | wc -l)
          echo "- Files with assertions: $ASSERTION_FILES" >> /tmp/copilot-test-review.md
          
          echo "" >> /tmp/copilot-test-review.md
          echo "### CI/CD Integration Check" >> /tmp/copilot-test-review.md
          
          # Check for test scripts in package.json
          if [ -f "package.json" ]; then
            if grep -q "test" package.json; then
              echo "- ✅ Test scripts found in package.json" >> /tmp/copilot-test-review.md
            else
              echo "- ❌ No test scripts in package.json" >> /tmp/copilot-test-review.md
            fi
            
            if grep -q "playwright" package.json; then
              echo "- ✅ Playwright dependency found" >> /tmp/copilot-test-review.md
            else
              echo "- ⚠️ Playwright dependency not found in package.json" >> /tmp/copilot-test-review.md
            fi
          fi
          
          # Check for GitHub Actions test workflows
          TEST_WORKFLOWS=$(find .github/workflows -name "*.yml" -o -name "*.yaml" | \
            xargs grep -l "test\|playwright" 2>/dev/null | wc -l)
          echo "- GitHub Actions workflows with tests: $TEST_WORKFLOWS" >> /tmp/copilot-test-review.md
          
          echo "" >> /tmp/copilot-test-review.md
          echo "### Web Functionality Coverage" >> /tmp/copilot-test-review.md
          
          # Check for web-related files that might need testing
          WEB_FILES=$(find . -name "*.html" -o -name "*.css" -o -name "*.js" | \
            grep -v node_modules | grep -v test | wc -l)
          echo "- Web files that may need E2E testing: $WEB_FILES" >> /tmp/copilot-test-review.md
          
          # Check for API endpoints that need testing
          API_FILES=$(find . -name "*.py" -o -name "*.js" -o -name "*.ts" | \
            xargs grep -l "route\|endpoint\|@app\|express" 2>/dev/null | wc -l)
          echo "- API endpoints that may need integration testing: $API_FILES" >> /tmp/copilot-test-review.md
          
          echo "" >> /tmp/copilot-test-review.md
          echo "### Test Improvement Recommendations" >> /tmp/copilot-test-review.md
          echo "- **High Priority:** Ensure all critical user workflows have E2E tests" >> /tmp/copilot-test-review.md
          echo "- **Medium Priority:** Implement both headed and headless test modes" >> /tmp/copilot-test-review.md
          echo "- **Low Priority:** Add visual regression testing for UI components" >> /tmp/copilot-test-review.md
          echo "- **Best Practice:** Use Page Object Model for maintainable tests" >> /tmp/copilot-test-review.md
          echo "- **CI/CD:** Ensure tests run on multiple browsers and environments" >> /tmp/copilot-test-review.md
          
          echo "" >> /tmp/copilot-test-review.md
          echo "### Playwright Migration Recommendations" >> /tmp/copilot-test-review.md
          
          # Check for other testing frameworks that could be migrated
          SELENIUM_TESTS=$(find . -name "*.py" -o -name "*.js" -o -name "*.ts" | \
            xargs grep -l "selenium\|webdriver" 2>/dev/null | wc -l)
          if [ $SELENIUM_TESTS -gt 0 ]; then
            echo "- **Migration Needed:** $SELENIUM_TESTS files using Selenium - consider migrating to Playwright" >> /tmp/copilot-test-review.md
          else
            echo "- ✅ No legacy Selenium tests found" >> /tmp/copilot-test-review.md
          fi
          
          # Note about GitHub Copilot integration
          echo "" >> /tmp/copilot-test-review.md
          echo "#### GitHub Copilot Integration Status" >> /tmp/copilot-test-review.md
          echo "⚠️ **Note:** GitHub Copilot CLI integration is currently unavailable." >> /tmp/copilot-test-review.md
          echo "This test review was generated using automated analysis tools." >> /tmp/copilot-test-review.md
          echo "For enhanced AI-powered test recommendations, consider:" >> /tmp/copilot-test-review.md
          echo "1. Using GitHub Copilot in your IDE for test generation" >> /tmp/copilot-test-review.md
          echo "2. Leveraging Playwright's codegen for test creation" >> /tmp/copilot-test-review.md
          echo "3. Implementing test-driven development practices" >> /tmp/copilot-test-review.md
          
          cat /tmp/copilot-test-review.md
        continue-on-error: true

      - name: Create or Update Test Review Issue
        uses: actions/github-script@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const analysis = fs.readFileSync('/tmp/test-analysis.md', 'utf8');
            
            // Include copilot test review if available
            let copilotTestReview = '';
            try {
              copilotTestReview = fs.readFileSync('/tmp/copilot-test-review.md', 'utf8');
            } catch (error) {
              console.log('Copilot test review not available:', error.message);
            }
            
            const date = new Date().toISOString().split('T')[0];
            const title = `Test Coverage Review - ${date}`;
            
            const body = `# Comprehensive Test Review
            
            This automated review ensures proper test coverage with Playwright for web tests.
            
            ${analysis}
            
            ${copilotTestReview}
            
            ## Playwright Test Status
            
            ✅ Tests run in multiple browsers: Chromium, Firefox, WebKit
            ✅ Tests run in both headed and headless modes
            
            ## Recommendations
            
            1. **Add Playwright tests** for all web-based functionality
            2. **Migrate existing web tests** to Playwright if not already using it
            3. **Add tests** for source files without coverage
            4. **Review test quality** and maintainability
            5. **Fix flaky tests** and timing issues
            6. **Ensure CI/CD integration** for all tests
            
            ## Action Items
            
            - [ ] Review files without tests and add coverage
            - [ ] Migrate non-Playwright web tests to Playwright
            - [ ] Fix any failing tests
            - [ ] Add documentation for test setup and execution
            
            ---
            *This issue was automatically generated by the Test Review workflow.*
            `;
            
            // Check if similar issue exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['test-coverage', 'automated'],
              per_page: 10
            });
            
            const recentIssue = issues.data.find(issue => {
              const createdAt = new Date(issue.created_at);
              const daysSinceCreation = (Date.now() - createdAt) / (1000 * 60 * 60 * 24);
              return daysSinceCreation < 7;
            });
            
            if (recentIssue) {
              console.log(`Recent issue found: #${recentIssue.number}, updating`);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: recentIssue.number,
                body: `## Updated Analysis (${date})\n\n${analysis}`
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['test-coverage', 'automated', 'playwright', 'needs-review']
              });
            }
